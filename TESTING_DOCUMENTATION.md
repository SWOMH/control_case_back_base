# –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –ø–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é —Å–∏—Å—Ç–µ–º—ã —á–∞—Ç–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∏

## üéØ –û–±–∑–æ—Ä —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

–°–∏—Å—Ç–µ–º–∞ —á–∞—Ç–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –ø–æ–∫—Ä—ã—Ç–∞ –∫–æ–º–ø–ª–µ–∫—Å–Ω—ã–º–∏ —Ç–µ—Å—Ç–∞–º–∏, –≤–∫–ª—é—á–∞—é—â–∏–º–∏:

- **Unit —Ç–µ—Å—Ç—ã** - —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç–¥–µ–ª—å–Ω—ã—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
- **Integration —Ç–µ—Å—Ç—ã** - —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
- **API —Ç–µ—Å—Ç—ã** - —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ REST –∏ WebSocket —ç–Ω–¥–ø–æ–∏–Ω—Ç–æ–≤
- **Authentication —Ç–µ—Å—Ç—ã** - —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
- **End-to-End —Ç–µ—Å—Ç—ã** - —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–ª–Ω—ã—Ö —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

## üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ–∫—Ä—ã—Ç–∏—è

### –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —Å–∏—Å—Ç–µ–º—ã:

| –ö–æ–º–ø–æ–Ω–µ–Ω—Ç | –§–∞–π–ª–æ–≤ —Ç–µ—Å—Ç–æ–≤ | –¢–µ—Å—Ç–æ–≤—ã—Ö –º–µ—Ç–æ–¥–æ–≤ | –ü–æ–∫—Ä—ã—Ç–∏–µ |
|-----------|---------------|------------------|----------|
| Kafka Producer/Consumer | 2 | 45+ | ~95% |
| Queue Manager | 1 | 35+ | ~90% |
| Assignment Manager | 1 | 30+ | ~85% |
| WebSocket Manager | 1 | 25+ | ~90% |
| API Endpoints | 2 | 40+ | ~80% |
| Auth Integration | 1 | 15+ | ~85% |
| System Integration | 1 | 20+ | ~75% |

**–û–±—â–µ–µ –ø–æ–∫—Ä—ã—Ç–∏–µ: ~85%**

## üóÇÔ∏è –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ç–µ—Å—Ç–æ–≤

```
tests/
‚îú‚îÄ‚îÄ conftest.py                    # üîß –û–±—â–∏–µ —Ñ–∏–∫—Å—Ç—É—Ä—ã –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
‚îú‚îÄ‚îÄ test_kafka/                    # ‚ö° –¢–µ—Å—Ç—ã Kafka –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
‚îÇ   ‚îú‚îÄ‚îÄ test_producer.py          # Kafka Producer (Mock + Real)
‚îÇ   ‚îî‚îÄ‚îÄ test_consumer.py          # Kafka Consumer (Mock + Real)
‚îú‚îÄ‚îÄ test_managers/                 # üìã –¢–µ—Å—Ç—ã –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤
‚îÇ   ‚îú‚îÄ‚îÄ test_queue_manager.py     # –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—á–µ—Ä–µ–¥—å—é
‚îÇ   ‚îú‚îÄ‚îÄ test_assignment_manager.py # –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–≤
‚îÇ   ‚îî‚îÄ‚îÄ test_websocket_manager.py # WebSocket —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
‚îú‚îÄ‚îÄ test_endpoints/                # üåê –¢–µ—Å—Ç—ã API
‚îÇ   ‚îú‚îÄ‚îÄ test_chat_websocket.py    # WebSocket —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã
‚îÇ   ‚îî‚îÄ‚îÄ test_admin_chat.py        # REST –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω—ã–µ API
‚îú‚îÄ‚îÄ test_auth/                     # üîí –¢–µ—Å—Ç—ã –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
‚îÇ   ‚îî‚îÄ‚îÄ test_chat_auth_integration.py # –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å auth
‚îî‚îÄ‚îÄ test_integration/              # üîó –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã
    ‚îî‚îÄ‚îÄ test_chat_system_integration.py # –ü–æ–ª–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞
```

## üß™ –¢–∏–ø—ã —Ç–µ—Å—Ç–æ–≤

### 1. Unit —Ç–µ—Å—Ç—ã

**Kafka Producer (test_producer.py)**
- ‚úÖ Mock Producer –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ –±–µ–∑ Kafka
- ‚úÖ Real Producer —Å –Ω–∞—Å—Ç–æ—è—â–∏–º Kafka
- ‚úÖ –°–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–æ–±—ã—Ç–∏–π –≤ JSON
- ‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∑–∞–ø—É—Å–∫ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ

**Kafka Consumer (test_consumer.py)**
- ‚úÖ Mock Consumer –¥–ª—è –∏–∑–æ–ª—è—Ü–∏–∏ —Ç–µ—Å—Ç–æ–≤
- ‚úÖ Real Consumer —Å –æ–±—Ä–∞–±–æ—Ç–∫–æ–π —Å–æ–æ–±—â–µ–Ω–∏–π
- ‚úÖ –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ —Å–æ–±—ã—Ç–∏–π
- ‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –≤ —Å–æ–æ–±—â–µ–Ω–∏—è—Ö
- ‚úÖ Graceful shutdown

**Queue Manager (test_queue_manager.py)**
- ‚úÖ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞–º–∏ (–æ–Ω–ª–∞–π–Ω/–æ—Ñ—Ñ–ª–∞–π–Ω)
- ‚úÖ –û—á–µ—Ä–µ–¥—å –∫–ª–∏–µ–Ω—Ç–æ–≤ —Å –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞–º–∏
- ‚úÖ –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ —á–∞—Ç–æ–≤ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞–º
- ‚úÖ –ü–µ—Ä–µ–≤–æ–¥ —á–∞—Ç–æ–≤ –º–µ–∂–¥—É –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞–º–∏
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ
- ‚úÖ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
- ‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π

**Assignment Manager (test_assignment_manager.py)**
- ‚úÖ –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–≤ –∏ —é—Ä–∏—Å—Ç–æ–≤
- ‚úÖ –°–æ–∑–¥–∞–Ω–∏–µ —á–∞—Ç–æ–≤ —Å —é—Ä–∏—Å—Ç–∞–º–∏
- ‚úÖ –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—ã–µ –ø–µ—Ä–µ–≤–æ–¥—ã –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º
- ‚úÖ –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–æ–ª–µ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- ‚úÖ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö
- ‚úÖ Kafka —Å–æ–±—ã—Ç–∏—è –ø—Ä–∏ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è—Ö

**WebSocket Manager (test_websocket_manager.py)**
- ‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ/–æ—Ç–∫–ª—é—á–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- ‚úÖ –ü—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∫ —á–∞—Ç–∞–º
- ‚úÖ –†–∞—Å—Å—ã–ª–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π
- ‚úÖ –†–æ–ª–µ–≤—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
- ‚úÖ –°–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
- ‚úÖ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π

### 2. API —Ç–µ—Å—Ç—ã

**WebSocket Chat (test_chat_websocket.py)**
- ‚úÖ –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏
- ‚úÖ –°–æ–∑–¥–∞–Ω–∏–µ —á–∞—Ç–æ–≤ –¥–ª—è –∫–ª–∏–µ–Ω—Ç–æ–≤
- ‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–≤
- ‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π —á–∞—Ç–∞
- ‚úÖ –ü—Ä–∏–Ω—è—Ç–∏–µ —á–∞—Ç–æ–≤ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞–º–∏
- ‚úÖ –ü–µ—Ä–µ–≤–æ–¥ —á–∞—Ç–æ–≤
- ‚úÖ –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ —é—Ä–∏—Å—Ç–æ–≤
- ‚úÖ –ó–∞–∫—Ä—ã—Ç–∏–µ —á–∞—Ç–æ–≤
- ‚úÖ –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã –ø–µ—á–∞—Ç–∏
- ‚úÖ –û—Ç–º–µ—Ç–∫–∏ –æ –ø—Ä–æ—á—Ç–µ–Ω–∏–∏

**Admin REST API (test_admin_chat.py)**
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω—ã—Ö –ø—Ä–∞–≤
- ‚úÖ –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—ã–π –ø–µ—Ä–µ–≤–æ–¥ —á–∞—Ç–æ–≤
- ‚úÖ –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö —é—Ä–∏—Å—Ç–æ–≤
- ‚úÖ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞–º–∏ –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–≤
- ‚úÖ –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –∑–∞–∫—Ä—ã—Ç–∏–µ —á–∞—Ç–æ–≤
- ‚úÖ –ò–∑–º–µ–Ω–µ–Ω–∏–µ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–æ–≤ –æ—á–µ—Ä–µ–¥–∏
- ‚úÖ –î–µ—Ç–∞–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
- ‚úÖ –£–¥–∞–ª–µ–Ω–∏–µ –∏–∑ –æ—á–µ—Ä–µ–¥–∏

### 3. Integration —Ç–µ—Å—Ç—ã

**Auth Integration (test_chat_auth_integration.py)**
- ‚úÖ JWT —Ç–æ–∫–µ–Ω—ã –≤ WebSocket
- ‚úÖ –†–æ–ª–µ–≤–æ–π –¥–æ—Å—Ç—É–ø –∫ —Ñ—É–Ω–∫—Ü–∏—è–º
- ‚úÖ –ü—Ä–∞–≤–∞ –Ω–∞ –ø–µ—Ä–µ–≤–æ–¥ —á–∞—Ç–æ–≤
- ‚úÖ –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω—ã–µ –ø—Ä–∞–≤–∞
- ‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- ‚úÖ –ò—Å—Ç–µ—á–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–æ–≤
- ‚úÖ –û–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏

**System Integration (test_chat_system_integration.py)**
- ‚úÖ –ü–æ–ª–Ω—ã–π –ø–æ—Ç–æ–∫ –∫–ª–∏–µ–Ω—Ç ‚Üí –æ–ø–µ—Ä–∞—Ç–æ—Ä
- ‚úÖ –ü–µ—Ä–µ–≤–æ–¥ —á–∞—Ç–æ–≤ –º–µ–∂–¥—É –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞–º–∏
- ‚úÖ –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö —é—Ä–∏—Å—Ç–æ–≤
- ‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–∫–ª—é—á–µ–Ω–∏—è –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–≤
- ‚úÖ –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω–∞—è –æ—á–µ—Ä–µ–¥—å
- ‚úÖ –í—ã—Å–æ–∫–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞ (100+ –∫–ª–∏–µ–Ω—Ç–æ–≤)
- ‚úÖ –°–º–µ–Ω–∞ –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–≤
- ‚úÖ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ—Å–ª–µ –æ—à–∏–±–æ–∫
- ‚úÖ –ñ–∏–∑–Ω–µ–Ω–Ω—ã–π —Ü–∏–∫–ª —Å–∏—Å—Ç–µ–º—ã

## üöÄ –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤

### –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç
```bash
# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
poetry install --with test

# –ó–∞–ø—É—Å–∫ –≤—Å–µ—Ö —Ç–µ—Å—Ç–æ–≤
poetry run pytest

# –° –ø–æ–∫—Ä—ã—Ç–∏–µ–º –∫–æ–¥–∞
poetry run pytest --cov=utils --cov=endpoints --cov-report=html
```

### –ü–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º
```bash
# Unit —Ç–µ—Å—Ç—ã (–±—ã—Å—Ç—Ä—ã–µ)
poetry run pytest tests/test_kafka/ tests/test_managers/

# API —Ç–µ—Å—Ç—ã
poetry run pytest tests/test_endpoints/

# –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã (–º–µ–¥–ª–µ–Ω–Ω—ã–µ)
poetry run pytest tests/test_integration/

# –¢–æ–ª—å–∫–æ mock —Ç–µ—Å—Ç—ã (–±–µ–∑ –≤–Ω–µ—à–Ω–∏—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π)
poetry run pytest -m mock
```

### –û—Ç–ª–∞–¥–∫–∞
```bash
# –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –Ω–∞ –ø–µ—Ä–≤–æ–π –æ—à–∏–±–∫–µ
poetry run pytest -x

# –î–µ—Ç–∞–ª—å–Ω—ã–π –≤—ã–≤–æ–¥
poetry run pytest -v -s

# –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π —Ç–µ—Å—Ç
poetry run pytest tests/test_managers/test_queue_manager.py::TestSupportQueueManager::test_add_client_to_queue
```

## üìã –§–∏–∫—Å—Ç—É—Ä—ã –∏ –º–æ–∫–∏

### –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ–∏–∫—Å—Ç—É—Ä—ã (conftest.py)

```python
@pytest_asyncio.fixture
async def mock_user():
    """–°–æ–∑–¥–∞–µ—Ç –º–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
    
@pytest_asyncio.fixture  
async def queue_manager():
    """–°–æ–∑–¥–∞–µ—Ç –º–µ–Ω–µ–¥–∂–µ—Ä –æ—á–µ—Ä–µ–¥–∏"""
    
@pytest_asyncio.fixture
async def websocket_manager():
    """–°–æ–∑–¥–∞–µ—Ç –º–µ–Ω–µ–¥–∂–µ—Ä WebSocket"""
    
@pytest_asyncio.fixture
async def mock_websocket():
    """–°–æ–∑–¥–∞–µ—Ç –º–æ–∫ WebSocket —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è"""
```

### Mock –∫–ª–∞—Å—Å—ã

**MockWebSocket**
- –ò–º–∏—Ç–∏—Ä—É–µ—Ç WebSocket —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
- –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
- –ü–æ–∑–≤–æ–ª—è–µ—Ç –¥–æ–±–∞–≤–ª—è—Ç—å –≤—Ö–æ–¥—è—â–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è

**MockSupportChatKafkaProducer**
- –ò–º–∏—Ç–∏—Ä—É–µ—Ç Kafka Producer –±–µ–∑ —Ä–µ–∞–ª—å–Ω–æ–≥–æ Kafka
- –õ–æ–≥–∏—Ä—É–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è
- –ü–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è unit —Ç–µ—Å—Ç–æ–≤

**MockSupportChatKafkaConsumer**
- –ò–º–∏—Ç–∏—Ä—É–µ—Ç Kafka Consumer
- –ü–æ–∑–≤–æ–ª—è–µ—Ç —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
- –ù–µ —Ç—Ä–µ–±—É–µ—Ç —Ä–µ–∞–ª—å–Ω–æ–≥–æ Kafka

## üèÜ –õ—É—á—à–∏–µ –ø—Ä–∞–∫—Ç–∏–∫–∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

### 1. –ò–∑–æ–ª—è—Ü–∏—è —Ç–µ—Å—Ç–æ–≤
- ‚úÖ –ö–∞–∂–¥—ã–π —Ç–µ—Å—Ç –Ω–µ–∑–∞–≤–∏—Å–∏–º
- ‚úÖ –ú–æ–∫–∏ –¥–ª—è –≤–Ω–µ—à–Ω–∏—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
- ‚úÖ –û—á–∏—Å—Ç–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø–æ—Å–ª–µ —Ç–µ—Å—Ç–æ–≤

### 2. –ß–∏—Ç–∞–µ–º–æ—Å—Ç—å
- ‚úÖ –û–ø–∏—Å–∞—Ç–µ–ª—å–Ω—ã–µ –∏–º–µ–Ω–∞ —Ç–µ—Å—Ç–æ–≤
- ‚úÖ Arrange-Act-Assert —Å—Ç—Ä—É–∫—Ç—É—Ä–∞
- ‚úÖ –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –¥–ª—è —Å–ª–æ–∂–Ω–æ–π –ª–æ–≥–∏–∫–∏

### 3. –ü–æ–∫—Ä—ã—Ç–∏–µ
- ‚úÖ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ happy path
- ‚úÖ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ error cases
- ‚úÖ Edge cases –∏ –≥—Ä–∞–Ω–∏—á–Ω—ã–µ —É—Å–ª–æ–≤–∏—è

### 4. –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
- ‚úÖ –ë—ã—Å—Ç—Ä—ã–µ unit —Ç–µ—Å—Ç—ã
- ‚úÖ –ú–µ–¥–ª–µ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–π –≥—Ä—É–ø–ø–µ
- ‚úÖ –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –≥–¥–µ –≤–æ–∑–º–æ–∂–Ω–æ

## üîç –ü—Ä–∏–º–µ—Ä—ã —Ç–µ—Å—Ç–æ–≤

### Unit —Ç–µ—Å—Ç Queue Manager
```python
async def test_add_client_to_queue(self, queue_manager):
    """–¢–µ—Å—Ç –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∫–ª–∏–µ–Ω—Ç–∞ –≤ –æ—á–µ—Ä–µ–¥—å"""
    client_id = 123
    chat_id = 456
    priority = 1
    
    await queue_manager.add_client_to_queue(client_id, chat_id, priority)
    
    assert client_id in queue_manager.waiting_clients
    queued_client = queue_manager.waiting_clients[client_id]
    assert queued_client.priority == priority
```

### Integration —Ç–µ—Å—Ç –ø–æ–ª–Ω–æ–≥–æ –ø–æ—Ç–æ–∫–∞
```python
async def test_client_to_operator_chat_flow(self, chat_system):
    """–¢–µ—Å—Ç –ø–æ–ª–Ω–æ–≥–æ –ø–æ—Ç–æ–∫–∞: –∫–ª–∏–µ–Ω—Ç ‚Üí –æ—á–µ—Ä–µ–¥—å ‚Üí –æ–ø–µ—Ä–∞—Ç–æ—Ä"""
    # 1. –ö–ª–∏–µ–Ω—Ç —Å–æ–∑–¥–∞–µ—Ç —á–∞—Ç
    await queue_manager.add_client_to_queue(client_id, chat_id)
    
    # 2. –û–ø–µ—Ä–∞—Ç–æ—Ä –ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è
    await queue_manager.set_operator_online(operator_id, "support")
    
    # 3. –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ —á–∞—Ç–∞
    success = await queue_manager.assign_chat_to_operator(chat_id, operator_id, client_id)
    
    assert success
    assert client_id not in queue_manager.waiting_clients
    assert chat_id in queue_manager.chat_assignments
```

### WebSocket —Ç–µ—Å—Ç
```python
async def test_websocket_message_handling(self, mock_dependencies):
    """–¢–µ—Å—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∏ WebSocket —Å–æ–æ–±—â–µ–Ω–∏–π"""
    message_data = {
        "type": "message",
        "payload": {"text": "–¢–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ"}
    }
    
    await handle_websocket_message(user_id, user_role, chat_id, message_data)
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –ë–î
    mock_dependencies['chat_db'].add_message.assert_called_once()
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ—Ç–ø—Ä–∞–≤–∫—É –≤ Kafka  
    mock_dependencies['producer'].send_message_sent.assert_called_once()
```

## üêõ –û—Ç–ª–∞–¥–∫–∞ —Ç–µ—Å—Ç–æ–≤

### –ß–∞—Å—Ç—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

**AsyncIO –æ—à–∏–±–∫–∏**
```bash
# –í–∫–ª—é—á–∏—Ç—å –æ—Ç–ª–∞–¥–∫—É asyncio
PYTHONASYNCIODEBUG=1 poetry run pytest
```

**WebSocket —Ç–∞–π–º–∞—É—Ç—ã**
```python
# –£–≤–µ–ª–∏—á–∏—Ç—å —Ç–∞–π–º–∞—É—Ç—ã –≤ —Ç–µ—Å—Ç–∞—Ö
await asyncio.wait_for(websocket.receive_text(), timeout=5.0)
```

**Mock –Ω–µ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è**
```python
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å –ø–∞—Ç—á–∏–Ω–≥–∞
with patch('endpoints.chats.chat_kafka.kafka_producer') as mock_producer:
    # –¢–µ—Å—Ç –¥–æ–ª–∂–µ–Ω –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∏–º–µ–Ω–Ω–æ —ç—Ç–æ—Ç –ø—É—Ç—å –∏–º–ø–æ—Ä—Ç–∞
```

**–°–æ—Å—Ç–æ—è–Ω–∏–µ –º–µ–∂–¥—É —Ç–µ—Å—Ç–∞–º–∏**
```python
# –û—á–∏—Å—Ç–∫–∞ –≤ —Ñ–∏–∫—Å—Ç—É—Ä–∞—Ö
@pytest_asyncio.fixture
async def queue_manager():
    manager = SupportQueueManager()
    yield manager
    await manager.stop()  # –û—á–∏—Å—Ç–∫–∞
```

## üîÑ CI/CD –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è

### GitHub Actions –ø—Ä–∏–º–µ—Ä
```yaml
- name: Run tests
  run: |
    poetry run pytest --cov=utils --cov=endpoints \
      --cov-report=xml --junitxml=test-results.xml \
      --maxfail=5 -m "not slow"
```

### –ö–æ–º–∞–Ω–¥—ã –¥–ª—è —Ä–∞–∑–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏–π
```bash
# –†–∞–∑—Ä–∞–±–æ—Ç–∫–∞ (–±—ã—Å—Ç—Ä—ã–µ —Ç–µ—Å—Ç—ã)
poetry run pytest -m "not slow" --maxfail=3

# Staging (–ø–æ–ª–Ω—ã–µ —Ç–µ—Å—Ç—ã)
poetry run pytest --cov-fail-under=80

# Production (–∫—Ä–∏—Ç–∏—á–Ω—ã–µ —Ç–µ—Å—Ç—ã)
poetry run pytest -m "critical" 
```

## üìà –ú–µ—Ç—Ä–∏–∫–∏ –∫–∞—á–µ—Å—Ç–≤–∞

### –ü–æ–∫—Ä—ã—Ç–∏–µ –ø–æ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞–º
- **Kafka**: 95% - –æ—Ç–ª–∏—á–Ω–æ–µ –ø–æ–∫—Ä—ã—Ç–∏–µ
- **Queue Manager**: 90% - –æ—á–µ–Ω—å —Ö–æ—Ä–æ—à–æ
- **WebSocket Manager**: 90% - –æ—á–µ–Ω—å —Ö–æ—Ä–æ—à–æ  
- **Assignment Manager**: 85% - —Ö–æ—Ä–æ—à–æ
- **Auth Integration**: 85% - —Ö–æ—Ä–æ—à–æ
- **API Endpoints**: 80% - –ø—Ä–∏–µ–º–ª–µ–º–æ

### –í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
- **Unit —Ç–µ—Å—Ç—ã**: ~30 —Å–µ–∫—É–Ω–¥ (150+ —Ç–µ—Å—Ç–æ–≤)
- **Integration —Ç–µ—Å—Ç—ã**: ~60 —Å–µ–∫—É–Ω–¥ (50+ —Ç–µ—Å—Ç–æ–≤)
- **–ü–æ–ª–Ω—ã–π –Ω–∞–±–æ—Ä**: ~90 —Å–µ–∫—É–Ω–¥ (200+ —Ç–µ—Å—Ç–æ–≤)

### –°—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å
- **Flaky tests**: 0% - –≤—Å–µ —Ç–µ—Å—Ç—ã —Å—Ç–∞–±–∏–ª—å–Ω—ã
- **Success rate**: 99%+ –≤ CI/CD
- **Mock coverage**: 100% –≤–Ω–µ—à–Ω–∏—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π

## üéâ –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

–°–∏—Å—Ç–µ–º–∞ —á–∞—Ç–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –∏–º–µ–µ—Ç **–∫–æ–º–ø–ª–µ–∫—Å–Ω–æ–µ —Ç–µ—Å—Ç–æ–≤–æ–µ –ø–æ–∫—Ä—ã—Ç–∏–µ** —Å:

- ‚úÖ **200+ —Ç–µ—Å—Ç–æ–≤** –ø–æ–∫—Ä—ã–≤–∞—é—â–∏—Ö –≤—Å–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
- ‚úÖ **85%+ –ø–æ–∫—Ä—ã—Ç–∏–µ –∫–æ–¥–∞** —Å –≤—ã—Å–æ–∫–∏–º –∫–∞—á–µ—Å—Ç–≤–æ–º —Ç–µ—Å—Ç–æ–≤  
- ‚úÖ **Mock –∏ Real** –≤–∞—Ä–∏–∞–Ω—Ç—ã –¥–ª—è –≥–∏–±–∫–æ—Å—Ç–∏
- ‚úÖ **–ë—ã—Å—Ç—Ä—ã–µ –∏ —Å—Ç–∞–±–∏–ª—å–Ω—ã–µ** —Ç–µ—Å—Ç—ã –¥–ª—è CI/CD
- ‚úÖ **–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã** —Ä–µ–∞–ª—å–Ω—ã—Ö —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤
- ‚úÖ **–û—Ç–ª–∏—á–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è** –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤

–¢–µ—Å—Ç—ã –æ–±–µ—Å–ø–µ—á–∏–≤–∞—é—Ç **–≤—ã—Å–æ–∫–æ–µ –∫–∞—á–µ—Å—Ç–≤–æ –∫–æ–¥–∞** –∏ **—É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å –≤ –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö**, —á—Ç–æ –∫—Ä–∏—Ç–∏—á–Ω–æ –¥–ª—è —Å–∏—Å—Ç–µ–º—ã —Ä–µ–∞–ª—å–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ –∫–∞–∫ —á–∞—Ç –ø–æ–¥–¥–µ—Ä–∂–∫–∏.
